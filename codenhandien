import gradio as gr
import cv2
import numpy as np
import tensorflow as tf
from ultralytics import YOLO
from PIL import Image
import os


file_model_path = "/kaggle/input/model4/other/default/1/model12.h5"


yolo_model = YOLO("yolov8n.pt")


keras_model = tf.keras.models.load_model(file_model_path)
input_shape = keras_model.input_shape[1:3]  # L·∫•y k√≠ch th∆∞·ªõc input c·ªßa model Keras


class_names = [
    "Ca hu kho", "Canh cai", "Canh chua", "Com trang", "Dau hu sot ca",
    "Ga chien", "Rau muong xao", "Thit kho", "Thit kho trung", "Trung chien"
]


food_prices = {
    "Ca hu kho": 20000,
    "Canh cai": 10000,
    "Canh chua": 10000,
    "Com trang": 5000,
    "Dau hu sot ca": 20000,
    "Ga chien": 20000,
    "Rau muong xao": 10000,
    "Thit kho": 20000,
    "Thit kho trung": 20000,
    "Trung chien": 5000
}

def classify_image(image):
 
    results = yolo_model(image)
    detections = results[0].boxes.data.cpu().numpy()
    predicted_foods = []
    total_price = 0

    for det in detections:
        x1, y1, x2, y2, confidence, class_id = det
        class_id = int(class_id)

        
        if confidence < 0.3:
            continue

        
        x1, y1, x2, y2 = map(int, [x1, y1, x2, y2])
      
        crop = image[y1:y2, x1:x2]
        
        if crop.size == 0:
            continue

       
        resized = cv2.resize(crop, input_shape)
        input_data = np.expand_dims(resized.astype(np.float32) / 255.0, axis=0)

     
        predictions = keras_model.predict(input_data)
        predicted_index = np.argmax(predictions)
        predicted_food = class_names[predicted_index]

        predicted_foods.append(predicted_food)
        total_price += food_prices.get(predicted_food, 0)

    if not predicted_foods:
        return "Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c m√≥n ƒÉn", "0ƒë"

    # T·∫°o chu·ªói k·∫øt qu·∫£ hi·ªÉn th·ªã c√°c m√≥n ƒÉn v√† t·ªïng ti·ªÅn
    result_text = "\n".join([f"{food}: {food_prices[food]:,}ƒë" for food in predicted_foods])
    total_price_text = f"{total_price:,}ƒë"
    return result_text, total_price_text

with gr.Blocks(title="Nh·∫≠n di·ªán M√≥n ƒÇn Canteen UEH", theme=gr.themes.Soft()) as demo:
    gr.Markdown("<h1 style='text-align: center;'>üçú Nh·∫≠n di·ªán M√≥n ƒÇn Canteen UEH (AI Challenges 3ITECH 2025)</h1>")
    gr.Markdown(f"<h3 style='text-align: center;'>C√°c m√≥n ƒÉn: {', '.join(class_names)}</h3>")

    with gr.Row():
        with gr.Column():
            gr.Markdown("üì∏ T·∫£i l√™n ·∫£nh m√¢m c∆°m:")
            image_input = gr.Image(type="numpy", label="·∫¢nh m√¢m c∆°m", interactive=True)
            nhan_dien_button = gr.Button("üîç Nh·∫≠n di·ªán v√† T√≠nh ti·ªÅn", variant="primary")
            reload_button = gr.Button("üîÑ T·∫£i l·∫°i", variant="secondary")

        with gr.Column():
            gr.Markdown("üåº K·∫øt qu·∫£ nh·∫≠n di·ªán:")
            food_output = gr.Textbox(label="C√°c m√≥n ƒÉn ƒë√£ ph√°t hi·ªán", lines=5)
            total_output = gr.Textbox(label="T·ªïng ti·ªÅn", lines=1)

    nhan_dien_button.click(fn=classify_image, inputs=image_input, outputs=[food_output, total_output])
    reload_button.click(fn=lambda: (None, "", ""), outputs=[
        image_input, food_output, total_output
    ])

demo.launch(debug=True, share=True)
